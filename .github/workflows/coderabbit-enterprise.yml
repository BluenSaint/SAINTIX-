name: ğŸ”¥ CodeRabbit Enterprise Review System

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, master, develop, staging]
  push:
    branches: [main, master, develop, staging]
  workflow_dispatch:
    inputs:
      audit_type:
        description: 'Type of audit to run'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - security
        - performance
        - accessibility
        - report-only

env:
  CODERABBIT_TOKEN: ${{ secrets.CODERABBIT_TOKEN }}
  NODE_VERSION: '20'

jobs:
  # ğŸ›¡ï¸ Security and Quality Gate
  security-gate:
    name: ğŸ›¡ï¸ Security & Quality Gate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ” Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install --frozen-lockfile
          
      - name: ğŸ” Run Security Audit
        run: |
          pnpm audit --audit-level=moderate
          
      - name: ğŸ§ª Run Tests
        run: |
          pnpm test --coverage
          
      - name: ğŸ—ï¸ Build Check
        run: |
          pnpm build
          
      - name: ğŸ“Š Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          
  # ğŸ¤– CodeRabbit AI Review
  coderabbit-review:
    name: ğŸ¤– CodeRabbit AI Review
    runs-on: ubuntu-latest
    needs: security-gate
    if: always() && (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch')
    
    steps:
      - name: ğŸ” Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ¤– CodeRabbit Review
        uses: coderabbitai/coderabbit-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          coderabbit_token: ${{ secrets.CODERABBIT_TOKEN }}
          review_level: 'comprehensive'
          auto_review: true
          
      - name: ğŸ“‹ Generate Review Summary
        run: |
          echo "## ğŸ¤– CodeRabbit AI Review Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Review Level**: Comprehensive Enterprise-Grade" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Check**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Accessibility Audit**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Quality**: âœ… Analyzed" >> $GITHUB_STEP_SUMMARY
          
  # ğŸ” Comprehensive Audit (Manual Trigger)
  comprehensive-audit:
    name: ğŸ” Comprehensive Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ” Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ”§ Setup Environment
        run: |
          chmod +x ./coderabbit_automation.sh
          
      - name: ğŸš€ Run Comprehensive Audit
        run: |
          case "${{ github.event.inputs.audit_type }}" in
            "full")
              ./coderabbit_automation.sh --full-audit
              ;;
            "security")
              ./coderabbit_automation.sh --security-scan
              ;;
            "performance")
              ./coderabbit_automation.sh --performance-audit
              ;;
            "accessibility")
              ./coderabbit_automation.sh --accessibility-audit
              ;;
            "report-only")
              ./coderabbit_automation.sh --report
              ;;
          esac
          
      - name: ğŸ“Š Upload Audit Results
        uses: actions/upload-artifact@v4
        with:
          name: coderabbit-audit-results
          path: |
            *.json
            *.md
            *.log
          retention-days: 30
          
      - name: ğŸ“‹ Create Issue for Critical Findings
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Critical Issues Found in CodeRabbit Audit',
              body: `
              ## ğŸš¨ Critical Issues Detected
              
              The CodeRabbit comprehensive audit has detected critical issues that require immediate attention.
              
              **Audit Type**: ${{ github.event.inputs.audit_type }}
              **Triggered By**: @${{ github.actor }}
              **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
              
              Please review the audit results and address the critical findings before proceeding.
              
              ---
              *Auto-generated by CodeRabbit Enterprise Review System*
              `,
              labels: ['critical', 'coderabbit', 'audit']
            })
            
  # ğŸ“ˆ Performance Monitoring
  performance-monitor:
    name: ğŸ“ˆ Performance Monitor
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'main')
    
    steps:
      - name: ğŸ” Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install --frozen-lockfile
          
      - name: ğŸ—ï¸ Build for Performance Analysis
        run: |
          pnpm build
          
      - name: ğŸ“Š Bundle Size Analysis
        run: |
          npx bundlesize
          
      - name: âš¡ Lighthouse Performance Audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
          
  # ğŸ”„ Auto-fix and Suggestions
  auto-fix:
    name: ğŸ”„ Auto-fix & Suggestions
    runs-on: ubuntu-latest
    needs: coderabbit-review
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft
    
    steps:
      - name: ğŸ” Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install -g pnpm
          pnpm install --frozen-lockfile
          
      - name: ğŸ”§ Auto-fix Issues
        run: |
          # Run ESLint with auto-fix
          pnpm lint --fix
          
          # Run Prettier formatting
          pnpm format
          
          # Fix TypeScript issues where possible
          pnpm type-check --fix
          
      - name: ğŸ“ Commit Auto-fixes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "CodeRabbit Auto-fix"
          
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "ğŸ¤– Auto-fix: CodeRabbit suggestions applied
            
            - ESLint auto-fixes applied
            - Code formatting standardized
            - TypeScript issues resolved
            
            Co-authored-by: CodeRabbit AI <coderabbit@ai.com>"
            git push
          else
            echo "No auto-fixes needed"
          fi
          
  # ğŸ“Š Reporting and Metrics
  reporting:
    name: ğŸ“Š Generate Reports
    runs-on: ubuntu-latest
    needs: [security-gate, coderabbit-review]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ” Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Generate Quality Report
        run: |
          echo "# ğŸ“Š Code Quality Report" > quality_report.md
          echo "" >> quality_report.md
          echo "**PR**: #${{ github.event.number }}" >> quality_report.md
          echo "**Author**: @${{ github.event.pull_request.user.login }}" >> quality_report.md
          echo "**Branch**: ${{ github.head_ref }}" >> quality_report.md
          echo "" >> quality_report.md
          echo "## ğŸ¯ Quality Metrics" >> quality_report.md
          echo "- **Security Gate**: ${{ needs.security-gate.result }}" >> quality_report.md
          echo "- **CodeRabbit Review**: ${{ needs.coderabbit-review.result }}" >> quality_report.md
          echo "" >> quality_report.md
          echo "## ğŸ” Review Summary" >> quality_report.md
          echo "All enterprise-grade quality checks have been completed." >> quality_report.md
          
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality_report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

# ğŸ”§ Workflow Configuration
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

